<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Landing Page</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="landing_page.css">

    <script>
        var printToConsole = function(data) {
            if (!data.color) {
                data.color = 'white';
            }

            // HTML escape angled bracket
            data.s = data.s.replace('<', '&lt;');

            if (data.header) {
                var htmlString = "<div style='color:{0};'><h{2}>{1}</h{2}></br></div>".format(data.color, data.s, data.header);
            }
            else {
                var htmlString = "<div style='color:{0};'>{1}</br></div>".format(data.color, data.s);
            }

            // Append new line and scroll to bottom
            var $line = $(htmlString);
            $('#console-statements').append($line);
            var elem = document.getElementById('console');
            elem.scrollTop = elem.scrollHeight;
        };

        function downloadVideo() {
            var $this = $(this);
            console.log("Download Video", $this);

            var $videoHolder = $this.parent();

            var embedUrl = $videoHolder.find('iframe').attr('src');
            var splitUrl = embedUrl.split('/');
            var videoID = splitUrl[splitUrl.length - 1].split('?')[0];

            console.log('src:', embedUrl, 'videoID:', videoID);
            //        var url = 'https://www.youtube.com/embed/YRor51Y35yA'


            var watchUrl = 'https://www.youtube.com/watch?v=' + videoID;

            var videoName;
            var dataToSend = {'url': watchUrl};
            console.log('data to send:', dataToSend);
            $.post("/download_video/", dataToSend, function (data, status) {
//                console.log('Video Downloaded.');
//                console.log(data);
                videoName = data; // todo for now

                $('#downloaded-videos').find('.video_title').forEach(function() {

                });

                // Remove download video button
                var $videoHolderClone = $videoHolder.clone();
                $videoHolderClone.find('.download').remove();

                // Add Title
//                console.log('name', videoName);
                var titleString = '<h3 class="video_title">' + videoName + '</h3>';
                $videoHolderClone.append(titleString);

                // Add process video button
                var processVideoButtonString = "<button class='video_button process' type=\"button\">Process Video</button>";
                var $processButton = $(processVideoButtonString);
                $videoHolderClone.append($processButton);
                $processButton.click(processVideo);

                // Append new videoHolder to downloaded videos and remove old one from new videos
                $('#downloaded-videos').append($videoHolderClone);
                $videoHolder.remove();
//                console.log(status);
            });
            toggleConsole();
            //TODO if fail of download return. or just do what i did above. Still need a fail function
        }

//        TODO TURN OFF BUTTON FOR A MINUTE OR SO
        function processVideo() {
            var $this = $(this);
            console.log("Process Video", $this);
            var $videoHolder = $this.parent();

            var videoName = $videoHolder.find('.video_title').text();

            var dataToSend = {'name': videoName};
            console.log('data to send:', dataToSend);
            $.post("/process_video/", dataToSend, function (data, status) {
                console.log('Video Processed.');
                console.log(data);


                // Remove download video button
//                var $videoHolderClone = $videoHolder.clone();
//                $videoHolderClone.find('.download').remove();
//
//                // Add Title
//                console.log('name', videoName);
//                var titleString = '<h3 class="video_title">' + videoName + '</h3>';
//                $videoHolderClone.append(titleString);
//
//                // Add process video button
//                var processVideoButtonString = "<button class='video_button process' type=\"button\">Process Video</button>";
//                var $processButton = $(processVideoButtonString);
//                $videoHolderClone.append($processButton);
//                $processButton.click(processVideo);
//
//                // Append new videoHolder to downloaded videos and remove old one from new videos
//                $('#downloaded-videos').append($videoHolderClone);
//                $videoHolder.remove();
//                console.log(status);
            });
        }

        function embedVideo() {
            var downloadVideoButtonString = "<button class='video_button download' type=\"button\">Download Video</button>";


            var url = $('#url').val();
            console.log('inside func. Url is:', url);

//        var videoID = 'p4kIwWHP8Vc';//working
//        videoID = 'ezyrSKgcyJw';
//        // todo LATER CHECK IF EXISTS
//        $.ajax({
////            url: "https://gdata.youtube.com/feeds/api/videos/" + videoID + "?v=2&alt=json",
//            url: 'https://www.googleapis.com/youtube/v3/videos?id=' + video_id + '&key=YOUR_API_KEY&part=snippet';
//            //dataType: "jsonp",
//            success: function(data) {
//                console.log('success');
//                console.log(data);
////                  $("#result").text(data);
//            },
//            error: function(jqXHR, textStatus, errorThrown)
//                    {
//                        // Handle errors here
//                        console.log('error')
//                        alert('ERRORS: ' + textStatus);
//                    }
//        });
            var splitUrl = url.split('/');
            var videoID = splitUrl[splitUrl.length - 1];
            // hacky bit to get bit after 'v='
            videoID = videoID.split('=')[1];

            var embedString = "<div class='video_holder'><iframe src=\"https://www.youtube.com/embed/" + videoID +
                    "?autoplay=1\" width=\"560\" height=\"315\" frameborder=\"0\" allowfullscreen></iframe></div>";
//        console.log(embedString)


            var $videoHolder = $(embedString);
            $('#new-videos').append($videoHolder);

            var $downloadButton = $(downloadVideoButtonString);
            $videoHolder.append($downloadButton);

            $downloadButton.click(downloadVideo);

            //TODO not necessary?
//            printToConsole({s: 'Video Embedded.'});
        }
    </script>
</head>
<body>

<div class="container-fluid">
    <div id="all-videos" class="col-sm-12">
        <div>
            <h1>Choose a video</h1>
        </div>

        <div>
            <form method="post" action="javascript:embedVideo();">
                <label for="url">Please enter a youtube URL:</label>
                <input id="url" type="text" name="url" size="60" value="https://www.youtube.com/watch?v=ezyrSKgcyJw" style="width: 600px; height: 40px; font-family:'Lucida Sans Unicode', 'Lucida Grande', sans-serif; font-size:22px;"/><br />
                <input class='video_button' type="submit" />
            </form>
        </div>

        <!-- TODO NON DOWNLOADED VIDEOS go to new videos. Once download button clicked move to downloaded-videos. Once process button clicked goes to processed videos but
        in the process empty whole page and turn it into processing mode.-->
        <!--TODO Process again button AND SHOW RESULTS PAGE button-->

        <div id="new-videos">
            <h1>New Videos</h1>
        </div>
        <!--TODO fix youtube errors on this and my website once and for all-->
        <!--todo HIDE and show with animation. -->
        <div id="downloaded-videos">
            <h1>Downloaded Videos</h1>
        </div>

        <div id="processed-videos">
            <h1>Processed Videos</h1>
        </div>


    </div>

    <div id="console-holder">
        <h1>Console</h1>
        <div id="console">
            <!--TODO better name than progress statements? console statements?-->
            <!--<div id="progress-statements">-->
            <!---->
            <!--</div>-->

            <div id="console-statements">

            </div>
        </div>
    </div>
</div>

<!--<script src="https://apis.google.com/js/client.js?onload=OnLoadCallback"></script>-->

<!--<script  src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>-->
<script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
    //TODO show videos ive processed before. Undereneath each video can press process video. Must store processed videos in file or just list of directories?
    var $console = $('#console-holder');
    var $allVideos = $('#all-videos');

    var consoleOn = false;
    function toggleConsole() {
        consoleOn = !consoleOn;

        if (!consoleOn) {
            $console.removeClass('col-sm-6');
            $allVideos.removeClass('col-sm-6');
            $allVideos.addClass('col-sm-12');
            $console.hide();
        }
        else {
            $console.addClass('col-sm-6');
            $allVideos.removeClass('col-sm-12');
            $allVideos.addClass('col-sm-6');
            $console.toggle('slide');
        }

    }

    $(function() {
        $console.hide();

        var socket = io.connect('http://' + document.domain + ':' + location.port);

        socket.on('connect', function() {
            console.log('Connected to server');
//            socket.emit('my event', {data: 'I\'m connected!'});
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
//            socket.emit('my event', {data: 'I\'m DISconnected!'});
        });

        if (!String.prototype.format) {
            String.prototype.format = function() {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function(match, number) {
                return typeof args[number] != 'undefined'
                ? args[number]
                : match
                ;
            });
            };
        }

        socket.on('print_event', function(data) {
            //TODO all below into function?
            console.log('data:', data); //debug

            printToConsole(data);
        });
    });
</script>
</body>
</html>