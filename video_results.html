<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<!--TODO change -->
	<title>Video Understanding</title>

	<link rel="stylesheet" type="text/css" href="video_results.css">


    <style>
	rect {
		fill: steelblue;
	}
</style>

</head>

<script src="js/handlebars-v4.0.5.js"></script>

<body>
<!--TODO make header bigger and descripts smaller and have different classes for all. -->
	<div id="header">
		<h1 id="video-title"></h1>
		<script id="header-template" type="text/x-handlebars-template">
            <div class="description">
			    <div>Number of frames: {{info.framecount}}</div>
                <div>Number of images:  {{info.num_images}}</div>
				<div>Number of scenes:  {{info.num_scenes}}</div>
				<div>FPS: {{info.fps}}</div>
            </div>
		</script>
	</div>


	<div id="page-wrap">
		<!--{{#if checkSceneChange scene_num}}-->
								<!--<div>GAY GAY GAY GAYT GAY GAEFRGEAGREAGARGEA</div>-->
							<!--{{/if}}-->

		<!--{{#if @last.scene_num '==' "212" }}-->
								<!--Last :(-->
							  <!--{{/if}}-->
		<!--{{#if @index "==" 0}}-->

							<!--{{/if}}-->

		<!--{{isEqual}}-->
								<!--<div>HEY HEYOOOO2131232131232131231</div>-->
							<!--{{/if}}-->
		<script id="image-template" type="text/x-handlebars-template">

			{{#each images}}
				<td>
					<div class="frame">
						<img class="img_frame" src="{{addDirectory image_name}}">
						<div class="description">
							<svg style="width:{{getFrameWidth}};">
								<g transform="translate(0,0)">
									{{#each dominant_colours}}
										<rect x="{{getStartRect count @index}}" width="{{getRectWidth count}}" height="40" style="fill:rgb({{getColourString col.[0] col.[1] col.[2]}})">

										</rect>
									{{/each}}
								</g>
							</svg>
                            <div>Frame Number: {{frame_number}}</div>
							<div>Time: {{divide frame_number}}s</div>
							<!--TODO ADD time out of full length of video.-->
							<!-- TODO add all images together to form timeline to see whole video in one go.!!!!!!!! video summarisation best idea ever-->
							<div>Scene number: <span class="scene_number_span">{{scene_num}}</span></div>
							<br>

                            <div class='scene_desc'>
								<!-- TODO if scene results exist.-->
								<h2>Scene Results 1</h2>
                                {{#each scene_results.scene_results1}}
                                    <div>{{label}} : {{probability}}</div>
                                {{/each}}
                            </div>
                            <br>
                            <div class='scene_desc'>
								<h2>Scene Results 2</h2>
                                {{#each scene_results.scene_results2}}
                                    <div>{{label}} : {{probability}}</div>
                                {{/each}}
                            </div>
							<br>
							<div class="object_list">
								<h2>Object Lists</h2>
								{{#each object_lists}}
									<div>{{this}}</div>
								{{/each}}
							</div>
                        </div>
					</div>
				</td>"
			{{/each}}
		</script>
	</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="jquery.mousewheel.js"></script>
<script>
	// Global Variables
	var scrollRate = 1000;
	var imageDirectory;
	var globalData;

	var frameWidth = 500.0;
	var numDominantColours;;
	var QueryString = function () {
	  // This function is anonymous, is executed immediately and
	  // the return value is assigned to QueryString!
	  var query_string = {};
	  var query = window.location.search.substring(1);
	  var vars = query.split("&");
	  for (var i=0;i<vars.length;i++) {
		var pair = vars[i].split("=");
			// If first entry with this name
		if (typeof query_string[pair[0]] === "undefined") {
		  query_string[pair[0]] = decodeURIComponent(pair[1]);
			// If second entry with this name
		} else if (typeof query_string[pair[0]] === "string") {
		  var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
		  query_string[pair[0]] = arr;
			// If third or later entry with this name
		} else {
		  query_string[pair[0]].push(decodeURIComponent(pair[1]));
		}
	  }
		return query_string;
	}();

	$(function() {
		$("#page-wrap").wrapInner("<table cellspacing='30'><tr>");  //TODO GET RID OF?
		var videoName = QueryString.video;
		$('#video-title').text(videoName);

		//TODO PUT TD ALL INSIDE TABLE!!!!! OUTSIDE AT THE MOMENT

		imageDirectory = 'example_images/' + videoName + '/';
		var result_file_path = imageDirectory + '/metadata/result_struct.json';
		loadDataset(result_file_path);

		$("body").mousewheel(function(event, delta) {
			//TODO fix when it hits the end
			this.scrollLeft -= (delta * scrollRate);
			event.preventDefault();
		});
	});

	// Data Loading
    function loadDataset(jsonpath) {
		$.getJSON(jsonpath, function(data) {
			console.log(data);
            console.log("Number of Images:", data.images.length);
			globalData = data;
			var $pageWrap = $("#page-wrap");
			imageDirectory = imageDirectory + 'images/full/';

			var headerScript = $("#header-template").html();
			var headerTemplate = Handlebars.compile(headerScript);
			var compiledHtml = headerTemplate(data);
			$("#header").append(compiledHtml);

			var last_scene_num;
			var i = 0;

			Handlebars.registerHelper('addDirectory', function(image_name) {
				return imageDirectory + image_name;
			});

			Handlebars.registerHelper('divide', function(frame_number) {
				return (frame_number / data.info.fps).toFixed(2);
			});

			Handlebars.registerHelper('checkSceneChange', function(scene_num, options) {
//				var returnValue = false;
//
//				if (i === 0) {
//					last_scene_num = parseInt($pageWrap.find('td:last-child').find('span.scene_number_span').html());
//					i++;
//					returnValue = true;
//					if (returnValue) {
//						return options.fn(this);
//					}
//					else {
//						return options.inverse(this);
//					}
//				}
//
//				if (parseInt(scene_num) != last_scene_num) {
//					last_scene_num = parseInt($pageWrap.find('td:last-child').find('span.scene_number_span').html());
//				}
//
//				returnValue = true;
//				if (returnValue) {
//					return options.fn(this);
//				}
//				else {
//					return options.inverse(this);
//				}

				var selected = false;
				  // lots of logic that determines if item is selected

				  if (selected) {
					  return options.fn(this);
				  }
			});

			Handlebars.registerHelper('ifCond', function (v1, operator, v2, options) {

				switch (operator) {
					case '==':
						return (v1 == v2) ? options.fn(this) : options.inverse(this);
					case '===':
						return (v1 === v2) ? options.fn(this) : options.inverse(this);
					case '<':
						return (v1 < v2) ? options.fn(this) : options.inverse(this);
					case '<=':
						return (v1 <= v2) ? options.fn(this) : options.inverse(this);
					case '>':
						return (v1 > v2) ? options.fn(this) : options.inverse(this);
					case '>=':
						return (v1 >= v2) ? options.fn(this) : options.inverse(this);
					case '&&':
						return (v1 && v2) ? options.fn(this) : options.inverse(this);
					case '||':
						return (v1 || v2) ? options.fn(this) : options.inverse(this);
					default:
						return options.inverse(this);
				}
			});

			Handlebars.registerHelper( 'isEqual', function (options) {
				var equal = false;
				// lots of logic that determines if item is selected

				if (index > 0 && data.images[index].scene_num === data.images[index-1].scene_num === true) {
					equal = true;
					console.log("@its true")
				}

				console.log(index, options);
				if (equal) {
//					return options.fn(this);
					return options.fn(this);
				}
//				else {
//					return options.inverse(this);
//				}
//				return (data.images[index].scene_num === data.images[index-1].scene_num) ? true : false;
			});

			Handlebars.registerHelper('getColourString', function (a, b, c) {
				return Math.round(a) + ", " +  Math.round(b) + ", " + Math.round(c);
			});

			Handlebars.registerHelper('getStartRect', function (count, index) {
				var width = (count / 10000.0) * frameWidth;

				var returnValue = widthTravelled;
				widthTravelled += width;
				if (index == numDominantColours - 1) widthTravelled = 0;
				return Math.round(returnValue);
			});

			Handlebars.registerHelper('getRectWidth', function (count) {
				var width = (count / 10000.0) * frameWidth;

				return Math.round(width);
			});

			Handlebars.registerHelper('getFrameWidth', function () {
				return frameWidth;
			});

			widthTravelled = 0;
            numDominantColours = data.images.dominant_colours.length;

			var theTemplateScript = $("#image-template").html();
			var theTemplate = Handlebars.compile(theTemplateScript);
			var theCompiledHtml = theTemplate(data);
			$pageWrap.append(theCompiledHtml);

			var lastSceneNumber = 0;
//			$this.find('.description').append("<div>SCENE CHANGE</div>");

			$pageWrap.find('td').each(function() {
				var $this = $(this);
				if (lastSceneNumber !== parseInt($this.find('.scene_number_span').text())) {
					lastSceneNumber = parseInt($this.find('.scene_number_span').text());
					$this.find('.description').append("<div style='color: red;'>SCENE CHANGE</div>");
				}
			})
		});
    }

</script>

</body>

</html>