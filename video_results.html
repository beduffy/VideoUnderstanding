<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<!--TODO change -->
	<title>Video Understanding</title>

	<link rel="stylesheet" type="text/css" href="video_results.css">


    <style>
	rect {
		fill: steelblue;
	}
</style>

</head>

<script src="js/handlebars-v4.0.5.js"></script>

<body>
<!--TODO make header bigger and descripts smaller and have different classes for all. -->
	<div id="header">
		<h1 id="video-title"></h1>
		<script id="header-template" type="text/x-handlebars-template">
            <div class="description">
			    <div>Number of frames: {{info.framecount}}</div>
                <div>Number of images:  {{info.num_images}}</div>
				<div>FPS: {{info.fps}}</div>
            </div>
		</script>
	</div>


	<div id="page-wrap">
		<script id="image-template" type="text/x-handlebars-template">
			{{#each images}}
				<td>
					<div class="frame">
						<img class="img_frame" src="{{addDirectory image_name}}">
						<div class="description">
                            <div>Frame Number: {{frame_number}}</div>
							<div>Time: {{divide frame_number}}s</div>
							<!--TODO ADD time out of full length of video.-->
							<!-- TODO add all images together to form timeline to see whole video in one go.!!!!!!!! video summarisation best idea ever-->
							<div>Scene number: {{scene_num}}</div>
							<br>

                            <div class='scene_desc'>
								<h2>Scene Results 1</h2>
                                {{#each scene_results.scene_results1}}
                                    <div>{{label}} : {{probability}}</div>
                                {{/each}}
                            </div>
                            <br>
                            <div class='scene_desc'>
								<h2>Scene Results 2</h2>
                                {{#each scene_results.scene_results2}}
                                    <div>{{label}} : {{probability}}</div>
                                {{/each}}
                            </div>
							<br>
							<div class="object_list">
								<h2>Object Lists</h2>
								{{#each object_lists}}
									<div>{{this}}</div>
								{{/each}}
							</div>
                        </div>
					</div>
				</td>"
			{{/each}}
		</script>
	</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="jquery.mousewheel.js"></script>
<script>
	// Global Variables
	var scrollRate = 1000;
	var imageDirectory;
	var globalData;

	var QueryString = function () {
	  // This function is anonymous, is executed immediately and
	  // the return value is assigned to QueryString!
	  var query_string = {};
	  var query = window.location.search.substring(1);
	  var vars = query.split("&");
	  for (var i=0;i<vars.length;i++) {
		var pair = vars[i].split("=");
			// If first entry with this name
		if (typeof query_string[pair[0]] === "undefined") {
		  query_string[pair[0]] = decodeURIComponent(pair[1]);
			// If second entry with this name
		} else if (typeof query_string[pair[0]] === "string") {
		  var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
		  query_string[pair[0]] = arr;
			// If third or later entry with this name
		} else {
		  query_string[pair[0]].push(decodeURIComponent(pair[1]));
		}
	  }
		return query_string;
	}();

	$(function() {
		$("#page-wrap").wrapInner("<table cellspacing='30'><tr>");
		var videoName = QueryString.video;
		$('#video-title').text(videoName);

		imageDirectory = 'example_images/' + videoName + '/';
		var result_file_path = imageDirectory + '/metadata/result_struct.json';
		loadDataset(result_file_path);

		$("body").mousewheel(function(event, delta) {
			//TODO fix when it hits the end
			this.scrollLeft -= (delta * scrollRate);
			event.preventDefault();
		});
	});

	// Data Loading
    function loadDataset(jsonpath) {
		$.getJSON(jsonpath, function(data) {
			console.log(data);
            console.log("Number of Images:", data.images.length);
			globalData = data;
			var $pageWrap = $("#page-wrap");
			imageDirectory = imageDirectory + 'images/full/';

			var headerScript = $("#header-template").html();
			var headerTemplate = Handlebars.compile(headerScript);
			var compiledHtml = headerTemplate(data);
			$("#header").append(compiledHtml);

			Handlebars.registerHelper('addDirectory', function(image_name) {
				return imageDirectory + image_name;
			});

			Handlebars.registerHelper('divide', function(frame_number) {
				// TODO change 30.0 to fps?
				return (frame_number / 30.0).toFixed(2);
			});

			var theTemplateScript = $("#image-template").html();
			var theTemplate = Handlebars.compile(theTemplateScript);
			var theCompiledHtml = theTemplate(data);
			$pageWrap.append(theCompiledHtml);
		});
    }

	function loadDataset2(jsonpath) {
		$.getJSON(jsonpath, function(data) {
			console.log(data);
			globalData = data;
			var $pageWrap = $("#page-wrap");

			for (var i = 0; i < data.images.length; i++) {
				//TODO wrap text description within frame width.
				var imagePath = imageDirectory + data.images[i].name;

				var fullBarWidth = 400;
				var svgString = '<svg><g transform="translate(0,0)">';
				var widthTravelled = 0;
				//TODO CHANGE 3 TO LENGTH
				for(var j = 0; j < 3; j++) {
					var width = data.images[i].kmeans[j][0] * 400;
					var fillString = 'style="fill:rgb(' + data.images[i].kmeans[j][1][0] + ',' + data.images[i].kmeans[j][1][1] + ',' + data.images[i].kmeans[j][1][2] + ')"';

					svgString += '<rect x=' + widthTravelled + ' width="' + width + '" height="40"' + fillString + '></rect>';
					widthTravelled += width;
				}
				svgString += '</g></svg>';

				//todo fix scene desc
				var sceneResultsString = "<div class='scene_desc'>";
				for (var a = 0; a < 5; a++) {
					var label_prob = data.images[i].scene_results.scene_results1[a].label + ' : ' + data.images[i].scene_results.scene_results1[a].probability;
					sceneResultsString += "<div style='font-size: large;'>" + label_prob + "</div>";
				}
				sceneResultsString += "</div";

				var sceneResultsString2 = "<div class='scene_desc'>";
				for (var a = 0; a < 5; a++) {
					var label_prob = data.images[i].scene_results.scene_results2[a].label + ' : ' + data.images[i].scene_results.scene_results2[a].probability;
					sceneResultsString2 += "<div style='font-size: large;'>" + label_prob + "</div>";
				}
				sceneResultsString2 += "</div";

                var weightSceneResultsString = "<div class='scene_desc'>";
                for (var a = 0; a < 5; a++) {
                    var label_prob1 = {"label": data.images[i].scene_results.scene_results1[a].label, "prob" : data.images[i].scene_results.scene_results1[a].probability};
                    for (var b = 0; b < 5; b++) {
                        var label_prob2 = {"label": data.images[i].scene_results.scene_results2[b].label, "prob" : data.images[i].scene_results.scene_results2[b].probability};
                        if (label_prob2.label === label_prob1.label) {
                            var new_label_prob = label_prob1.label + ' : ' + (label_prob2.prob + label_prob1.prob);
					        weightSceneResultsString += "<div style='font-size: large;'>" + new_label_prob + "</div>";
                            break;
                        }
                    }
                }
                weightSceneResultsString += "</div";

				var htmlString = "<td><div class='frame' > <img class='img_frame' src='" + imagePath + "' > " +
						svgString + sceneResultsString + "<br><br>" + sceneResultsString2 + "<br>" + weightSceneResultsString + "<br><br>" +//+ "<div class='description'>"  + "</div> " +
						"</div></td>";

				$pageWrap.append(htmlString);
			}
		});
	}

</script>

</body>

</html>